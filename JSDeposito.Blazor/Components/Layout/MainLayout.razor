@using MudBlazor
@inject NavigationManager Navigation
@inherits LayoutComponentBase
@inject CartService CartService

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>

    <MudAppBar Color="Color.Primary">

        <MudText Typo="Typo.h6">
            &lt; JS Depósito &gt;
        </MudText>

        <MudSpacer />

        <!-- Carrinho -->
        <MudMenu OffsetY="true"
                 Dense="true"
                 CloseOnClick="false"
                 CloseOnItemClick="false">

            <ActivatorContent>
                <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart">
                    <MudBadge Content="@CartService.TotalItens"
                              Color="Color.Error"
                              Visible="@(CartService.TotalItens > 0)" />
                </MudIconButton>
            </ActivatorContent>

            <ChildContent>
                <MudPaper Class="pa-3" Style="width:350px">
                    <MudText Typo="Typo.h6">🛒 Carrinho</MudText>
                    <MudDivider Class="my-2" />


                    @foreach (var item in CartService.Pedido!.Itens)
                    {
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="mb-2">

                            <!-- Foto -->
                            <MudAvatar Image="images/sem-foto.png" Size="Size.Medium" />

                            <!-- Nome -->
                            <MudText Class="flex-grow-1">
                                @item.ProdutoNome
                            </MudText>

                            <!-- Quantidade com setas -->
                            <MudNumericField T="int"
                                             Min="1"
                                             Value="@item.Quantidade"
                                             Immediate="true"
                                             HideSpinButtons="false"
                                             Style="width:70px"
                                             ValueChanged="q => AlterarQuantidade(item.ProdutoId, q)"
                                             StopPropagation="true" />

                            <!-- Remover -->
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           OnClick="() => Remover(item.ProdutoId)"
                                           StopPropagation="true" />
                        </MudStack>
                    }

                    <MudDivider Class="my-2" />

                    <MudText>
                        Total: <b>R$ @CartService.Pedido.Total.ToString("N2")</b>
                    </MudText>

                    <MudButton FullWidth Color="Color.Primary" OnClick="IrCheckout">
                        Finalizar compra
                    </MudButton>
                </MudPaper>
            </ChildContent>
        </MudMenu>

        <MudIconButton Icon="@Icons.Material.Filled.Person"
                       Color="Color.Inherit" />

    </MudAppBar>

    <MudMainContent Class="pa-4">
        @Body
    </MudMainContent>

</MudLayout>

@code {

    protected override void OnInitialized()
    {
        CartService.OnChange += StateHasChanged;
    }

    async Task Remover(int produtoId)
    {
        await CartService.RemoverItemAsync(produtoId);
    }

    async Task AlterarQuantidade(int produtoId, int quantidade)
    {
        await CartService.AlterarQuantidadeAsync(produtoId, quantidade);
    }

    void IrCheckout()
        => Navigation.NavigateTo("/checkout");
}
